name: Crosslink Tests

on:
  merge_group:
    types: [checks_requested]
  pull_request:
    branches: ["main"]

# See: https://github.com/ShieldedLabs/zebra-crosslink/settings/variables/actions
env:
  RUST_LOG: ${{ vars.RUST_LOG }} # defaults to 'info'
  RUST_BACKTRACE: ${{ vars.RUST_BACKTRACE }} # defaults to 1
  RUST_LIB_BACKTRACE: ${{ vars.RUST_LIB_BACKTRACE }} # defaults to 0
  COLORBT_SHOW_HIDDEN: ${{ vars.COLORBT_SHOW_HIDDEN }} # disables frame filtering, defaults to 0
  CARGO_INCREMENTAL: ${{ vars.CARGO_INCREMENTAL }} # defaults to 0

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and Test (Crosslink)
    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        sudo apt-get install protobuf-compiler
        rustup toolchain install stable --profile minimal
    - uses: Swatinem/rust-cache@v2
    - name: Static Analysis
      run: cargo fmt --check
    - name: Run Crosslink Tests
      run: cargo test --test crosslink*
    - name: Ensure docs generate
      run: cargo doc
    - name: Regression tests # mostly
      if: github.ref == 'refs/heads/main'
      run: cargo test
